<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø­Ø« BIN - Doc_HEMA Team</title>
    <link rel="stylesheet" href="admin.css">
    <style>
        /* BIN Search Specific Styles */
        .bin-search-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .search-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .search-header h1 {
            color: #FFD700;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .search-header p {
            color: #888;
            font-size: 1.1em;
        }

        .search-box {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .search-box input[type="text"] {
            width: 350px;
            padding: 15px 20px;
            font-size: 18px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            transition: all 0.3s ease;
        }

        .search-box input[type="text"]:focus {
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            outline: none;
        }

        .search-box button {
            padding: 15px 40px;
            font-size: 18px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a2e;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .search-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
        }

        .search-box button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            margin-top: 30px;
        }

        .result-card {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .result-card h3 {
            color: #FFD700;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bin-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .bin-info-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border-right: 3px solid #FFD700;
        }

        .bin-info-item label {
            display: block;
            color: #888;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .bin-info-item span {
            color: #fff;
            font-size: 1.1em;
            font-weight: 600;
        }

        .similar-bins-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .similar-bins-table th,
        .similar-bins-table td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .similar-bins-table th {
            background: rgba(255, 215, 0, 0.1);
            color: #FFD700;
            font-weight: 600;
        }

        .similar-bins-table tr:hover {
            background: rgba(255, 215, 0, 0.05);
        }

        .file-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .file-badge.luozi {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .file-badge.quanzi {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .no-results {
            text-align: center;
            padding: 50px;
            color: #888;
        }

        .no-results .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .loading-spinner {
            text-align: center;
            padding: 50px;
        }

        .loading-spinner .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 215, 0, 0.2);
            border-top-color: #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #FFD700;
            text-decoration: none;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .stat-box {
            flex: 1;
            min-width: 200px;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .stat-box .value {
            font-size: 2em;
            color: #FFD700;
            font-weight: bold;
        }

        .stat-box .label {
            color: #888;
            margin-top: 5px;
        }

        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.3), transparent);
            margin: 30px 0;
        }

        .country-tag {
            display: inline-block;
            padding: 3px 8px;
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .grade-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .grade-tag.platinum {
            background: rgba(192, 192, 192, 0.2);
            color: #c0c0c0;
        }

        .grade-tag.gold {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
        }

        .grade-tag.classic {
            background: rgba(52, 73, 94, 0.3);
            color: #95a5a6;
        }

        .grade-tag.signature {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
        }

        .db-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 15px;
        }

        .db-status.connected {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
        }

        .db-status.error {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .db-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .search-type-btn {
            padding: 10px 20px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .search-type-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
        }

        .search-type-btn.active {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a2e;
            border-color: #FFD700;
            font-weight: bold;
        }

        .adv-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        .adv-input:focus {
            border-color: #FFD700;
            outline: none;
        }

        .adv-input option {
            background: #1a1a2e;
            color: #fff;
        }
    </style>
</head>

<body>
    <div class="bin-search-container">
        <a href="index.html" class="back-link">
            <span>â†’</span>
            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </a>

        <div class="search-header">
            <h1>ğŸ” Ø¨Ø­Ø« BIN</h1>
            <p>Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª BIN Ø¨Ù…Ø®ØªÙ„Ù Ø§Ù„Ø·Ø±Ù‚ - Ø¨Ø±Ù‚Ù… BINØŒ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†ÙƒØŒ Ø§Ù„Ø¯ÙˆÙ„Ø©ØŒ ÙˆØ£ÙƒØ«Ø±</p>

            <!-- Search Type Selector -->
            <div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap;">
                <button class="search-type-btn active" data-type="bin" onclick="setSearchType('bin')">ğŸ”¢ Ø±Ù‚Ù…
                    BIN</button>
                <button class="search-type-btn" data-type="bank" onclick="setSearchType('bank')">ğŸ¦ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ</button>
                <button class="search-type-btn" data-type="country" onclick="setSearchType('country')">ğŸŒ
                    Ø§Ù„Ø¯ÙˆÙ„Ø©</button>
                <button class="search-type-btn" data-type="brand" onclick="setSearchType('brand')">ğŸ’³ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
                    Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</button>
                <button class="search-type-btn" data-type="grade" onclick="setSearchType('grade')">â­ Ø§Ù„Ø¯Ø±Ø¬Ø©</button>
                <button class="search-type-btn" data-type="combo" onclick="setSearchType('combo')">ğŸ”— Ù…Ø±ÙƒØ¨
                    (VISA-DEBIT-GOLD)</button>
                <button class="search-type-btn" data-type="advanced" onclick="setSearchType('advanced')">âš™ï¸ Ø¨Ø­Ø«
                    Ù…ØªÙ‚Ø¯Ù…</button>
            </div>

            <!-- Simple Search Box -->
            <div class="search-box" id="simple-search">
                <input type="text" id="search-input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… BIN (Ù…Ø«Ø§Ù„: 450979)" maxlength="50">
                <button id="search-btn" onclick="performSearch()">ğŸ” Ø¨Ø­Ø«</button>
            </div>

            <!-- Advanced Search Panel -->
            <div id="advanced-search"
                style="display: none; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; margin-top: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <label style="display: block; color: #888; margin-bottom: 5px;">Ø±Ù‚Ù… BIN</label>
                        <input type="text" id="adv-bin" class="adv-input" placeholder="450979" maxlength="8">
                    </div>
                    <div>
                        <label style="display: block; color: #888; margin-bottom: 5px;">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ</label>
                        <input type="text" id="adv-bank" class="adv-input" placeholder="Ù…Ø«Ø§Ù„: BANK OF AMERICA">
                    </div>
                    <div>
                        <label style="display: block; color: #888; margin-bottom: 5px;">Ø§Ù„Ø¯ÙˆÙ„Ø©</label>
                        <input type="text" id="adv-country" class="adv-input" placeholder="Ù…Ø«Ø§Ù„: UNITED STATES">
                    </div>
                    <div>
                        <label style="display: block; color: #888; margin-bottom: 5px;">Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</label>
                        <select id="adv-brand" class="adv-input">
                            <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
                            <option value="VISA">VISA</option>
                            <option value="MASTERCARD">MASTERCARD</option>
                            <option value="AMERICAN EXPRESS">AMERICAN EXPRESS</option>
                            <option value="DISCOVER">DISCOVER</option>
                            <option value="JCB">JCB</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; color: #888; margin-bottom: 5px;">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
                        <select id="adv-cardType" class="adv-input">
                            <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
                            <option value="CREDIT">CREDIT</option>
                            <option value="DEBIT">DEBIT</option>
                            <option value="PREPAID">PREPAID</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; color: #888; margin-bottom: 5px;">Ø§Ù„Ø¯Ø±Ø¬Ø©</label>
                        <select id="adv-grade" class="adv-input">
                            <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
                            <option value="CLASSIC">CLASSIC</option>
                            <option value="GOLD">GOLD</option>
                            <option value="PLATINUM">PLATINUM</option>
                            <option value="SIGNATURE">SIGNATURE</option>
                            <option value="INFINITE">INFINITE</option>
                            <option value="BUSINESS">BUSINESS</option>
                        </select>
                    </div>
                </div>
                <button onclick="performAdvancedSearch()"
                    style="margin-top: 20px; padding: 12px 40px; background: linear-gradient(135deg, #FFD700, #FFA500); color: #1a1a2e; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px;">ğŸ”
                    Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…</button>
            </div>

            <div class="db-status connected" id="db-status">
                <span class="dot"></span>
                <span id="db-status-text">Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
            </div>
        </div>

        <div id="loading" class="loading-spinner" style="display: none;">
            <div class="spinner"></div>
            <p style="color: #888;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>

        <div id="results-container" class="results-section" style="display: none;">
            <!-- BIN Info -->
            <div id="bin-details" class="result-card">
                <h3>ğŸ“Š ØªÙØ§ØµÙŠÙ„ BIN</h3>
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="value" id="bin-number">-</div>
                        <div class="label">Ø±Ù‚Ù… BIN</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="found-files">-</div>
                        <div class="label">Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ</div>
                    </div>
                </div>

                <!-- Sort Controls -->
                <div id="sort-controls"
                    style="display: none; margin: 15px 0; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                    <label style="color: #FFD700; margin-left: 10px;">ğŸ”ƒ ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨:</label>
                    <select id="sort-select" onchange="applySorting()"
                        style="padding: 10px 15px; background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; color: #fff; cursor: pointer;">
                        <option value="count-desc">ğŸ“Š Ø§Ù„Ø¹Ø¯Ø¯ (Ø§Ù„Ø£Ø¹Ù„Ù‰ â† Ø§Ù„Ø£Ù‚Ù„)</option>
                        <option value="count-asc">ğŸ“Š Ø§Ù„Ø¹Ø¯Ø¯ (Ø§Ù„Ø£Ù‚Ù„ â† Ø§Ù„Ø£Ø¹Ù„Ù‰)</option>
                        <option value="bin-asc">ğŸ”¢ Ø±Ù‚Ù… BIN (ØªØµØ§Ø¹Ø¯ÙŠ)</option>
                        <option value="bin-desc">ğŸ”¢ Ø±Ù‚Ù… BIN (ØªÙ†Ø§Ø²Ù„ÙŠ)</option>
                        <option value="country-asc">ğŸŒ Ø§Ù„Ø¯ÙˆÙ„Ø© (Ø£-ÙŠ)</option>
                        <option value="bank-asc">ğŸ¦ Ø§Ù„Ø¨Ù†Ùƒ (Ø£-ÙŠ)</option>
                    </select>
                </div>

                <div id="bin-info-grids"></div>
            </div>

            <!-- Similar BINs in Same Country -->
            <div id="same-country-section" class="result-card">
                <h3>ğŸ¦ BINs Ù…Ø´Ø§Ø¨Ù‡Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¯ÙˆÙ„Ø© (Ù†ÙØ³ Ø§Ù„Ø¨Ù†Ùƒ + Ø§Ù„Ø¯Ø±Ø¬Ø©)</h3>
                <div id="same-country-content"></div>
            </div>

            <div class="section-divider"></div>

            <!-- Similar BINs in Other Countries -->
            <div id="other-countries-section" class="result-card">
                <h3>ğŸŒ BINs Ù…Ø´Ø§Ø¨Ù‡Ø© ÙÙŠ Ø¯ÙˆÙ„ Ø£Ø®Ø±Ù‰ (Ù†ÙØ³ Ø§Ù„Ù†ÙˆØ¹ + Ø§Ù„Ø¹Ù„Ø§Ù…Ø© + Ø§Ù„Ø¯Ø±Ø¬Ø©)</h3>
                <div id="other-countries-content"></div>
            </div>
        </div>

        <div id="no-results" class="no-results" style="display: none;">
            <div class="icon">ğŸ”</div>
            <h2>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬</h2>
            <p>ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… BIN ØµØ­ÙŠØ­</p>
        </div>
    </div>

    <script>
        // Auth Check - Redirect to login if not logged in
        if (!sessionStorage.getItem('adminLoggedIn')) {
            alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
            window.location.href = 'index.html';
        }

        // Appwrite Configuration
        const APPWRITE_CONFIG = {
            endpoint: 'https://nyc.cloud.appwrite.io/v1',
            projectId: '693631c8001ac4fbc231',
            databaseId: '69363201001bc7a64088',
            collectionId: 'bin_database',
            apiSecret: 'standard_917cef86aef581038cb102a0b6d645aa4574cdccefe56659604f22954dba8b1213ac7a0172d73857e904188fba17e8574f23cfb1f4393301aae31c20b8213b086293b0f8c0f3a581e0862ef5db10ad03b749561368f61778ddf118941af5137eeae8ffc196cdb3f3b8a4ac489dd99a67a059fdfc00afad2893b8858a9ca904e3'
        };

        // Get headers for API requests
        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'X-Appwrite-Project': APPWRITE_CONFIG.projectId,
                'X-Appwrite-Key': APPWRITE_CONFIG.apiSecret
            };
        }

        // Search BINs in Appwrite
        async function searchInAppwrite(queries) {
            let url = `${APPWRITE_CONFIG.endpoint}/databases/${APPWRITE_CONFIG.databaseId}/collections/${APPWRITE_CONFIG.collectionId}/documents`;

            if (queries && queries.length > 0) {
                const queryParams = queries.map(q => `queries[]=${encodeURIComponent(JSON.stringify(q))}`).join('&');
                url += `?${queryParams}`;
            }

            const response = await fetch(url, {
                method: 'GET',
                headers: getHeaders()
            });

            if (!response.ok) {
                const error = await response.json();
                console.error('Appwrite error:', error);
                throw new Error('Failed to fetch from database');
            }

            return await response.json();
        }

        // Get BINs by exact BIN number
        async function getBinByNumber(binNumber) {
            return await searchInAppwrite([
                { "method": "equal", "attribute": "bin", "values": [binNumber] }
            ]);
        }

        // Get similar BINs (same bank + grade + country)
        async function getSimilarBinsSameCountry(country, bank, grade) {
            try {
                return await searchInAppwrite([
                    { "method": "equal", "attribute": "country", "values": [country] },
                    { "method": "equal", "attribute": "bank", "values": [bank] },
                    { "method": "equal", "attribute": "grade", "values": [grade] },
                    { "method": "limit", "values": [500] }
                ]);
            } catch (error) {
                console.error('Error fetching same country BINs:', error);
                return { documents: [] };
            }
        }

        // Get similar BINs in other countries (same cardType + brand + grade)
        async function getSimilarBinsOtherCountries(cardType, brand, grade, excludeCountry) {
            try {
                return await searchInAppwrite([
                    { "method": "equal", "attribute": "cardType", "values": [cardType] },
                    { "method": "equal", "attribute": "brand", "values": [brand] },
                    { "method": "equal", "attribute": "grade", "values": [grade] },
                    { "method": "notEqual", "attribute": "country", "values": [excludeCountry] },
                    { "method": "limit", "values": [500] }
                ]);
            } catch (error) {
                console.error('Error fetching other countries BINs:', error);
                return { documents: [] };
            }
        }

        // Search for BIN
        async function searchBIN() {
            const binInput = document.getElementById('bin-search-input').value.trim();

            if (!binInput) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… BIN');
                return;
            }

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results-container').style.display = 'none';
            document.getElementById('no-results').style.display = 'none';

            try {
                // Search for exact BIN
                const result = await getBinByNumber(binInput);
                const results = result.documents || [];

                // Hide loading
                document.getElementById('loading').style.display = 'none';

                if (results.length === 0) {
                    document.getElementById('no-results').style.display = 'block';
                    return;
                }

                // Show results
                await displayResults(binInput, results);

            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('no-results').style.display = 'block';
                updateDbStatus(false, 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }

        // Display results
        async function displayResults(bin, results) {
            document.getElementById('results-container').style.display = 'block';

            // BIN Number
            document.getElementById('bin-number').textContent = bin;

            // Found in files
            const filesFound = [];
            if (results.some(r => r.source === 'luozi')) filesFound.push('è£¸èµ„');
            if (results.some(r => r.source === 'quanzi')) filesFound.push('å…¨èµ„');
            document.getElementById('found-files').textContent = filesFound.join(' + ') || '-';

            // BIN Info Grids
            let infoGridHtml = '';
            results.forEach((item) => {
                infoGridHtml += `
                    <div style="margin-bottom: 20px;">
                        <span class="file-badge ${item.source === 'luozi' ? 'luozi' : 'quanzi'}">
                            ${item.source === 'luozi' ? 'è£¸èµ„' : 'å…¨èµ„'}
                        </span>
                        <div class="bin-info-grid" style="margin-top: 10px;">
                            <div class="bin-info-item">
                                <label>Ø§Ù„Ø¯ÙˆÙ„Ø©</label>
                                <span>${item.country || '-'}</span>
                            </div>
                            <div class="bin-info-item">
                                <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
                                <span>${item.cardType || '-'}</span>
                            </div>
                            <div class="bin-info-item">
                                <label>Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</label>
                                <span>${item.brand || '-'}</span>
                            </div>
                            <div class="bin-info-item">
                                <label>Ø§Ù„ØªØµÙ†ÙŠÙ/Ø§Ù„Ø¯Ø±Ø¬Ø©</label>
                                <span>${item.grade || '-'}</span>
                            </div>
                            <div class="bin-info-item">
                                <label>Ø§Ù„Ø¨Ù†Ùƒ</label>
                                <span>${item.bank || '-'}</span>
                            </div>
                            <div class="bin-info-item">
                                <label>Ø§Ù„Ø¹Ø¯Ø¯</label>
                                <span>${item.count || 0}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('bin-info-grids').innerHTML = infoGridHtml;

            // Get main result for similarity search
            const mainResult = results[0];

            // Find similar BINs in same country
            try {
                const sameCountryResult = await getSimilarBinsSameCountry(
                    mainResult.country,
                    mainResult.bank,
                    mainResult.grade
                );
                const sameCountryBins = (sameCountryResult.documents || [])
                    .filter(item => item.bin !== bin);
                displaySimilarBins('same-country-content', sameCountryBins, bin);
            } catch (error) {
                document.getElementById('same-country-content').innerHTML =
                    '<p style="color: #888; text-align: center; padding: 30px;">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>';
            }

            // Find similar BINs in other countries
            try {
                const otherCountriesResult = await getSimilarBinsOtherCountries(
                    mainResult.cardType,
                    mainResult.brand,
                    mainResult.grade,
                    mainResult.country
                );
                const otherCountriesBins = (otherCountriesResult.documents || [])
                    .filter(item => item.bin !== bin);
                displaySimilarBins('other-countries-content', otherCountriesBins, bin);
            } catch (error) {
                document.getElementById('other-countries-content').innerHTML =
                    '<p style="color: #888; text-align: center; padding: 30px;">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>';
            }
        }

        // Display similar BINs in table
        function displaySimilarBins(containerId, items, searchedBin) {
            const container = document.getElementById(containerId);

            if (items.length === 0) {
                container.innerHTML = '<p style="color: #888; text-align: center; padding: 30px;">Ù„Ø§ ØªÙˆØ¬Ø¯ BINs Ù…Ø´Ø§Ø¨Ù‡Ø©</p>';
                return;
            }

            // Remove duplicates based on BIN
            const uniqueItems = [];
            const seenBins = new Set();
            items.forEach(item => {
                if (!seenBins.has(item.bin)) {
                    seenBins.add(item.bin);
                    uniqueItems.push(item);
                }
            });

            let tableHtml = `
                <p style="color: #FFD700; margin-bottom: 15px;">ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${uniqueItems.length} BIN Ù…Ø´Ø§Ø¨Ù‡</p>
                <div class="table-container">
                    <table class="similar-bins-table">
                        <thead>
                            <tr>
                                <th>BIN</th>
                                <th>Ø§Ù„Ø¯ÙˆÙ„Ø©</th>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø§Ù„Ø¹Ù„Ø§Ù…Ø©</th>
                                <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                <th>Ø§Ù„Ø¨Ù†Ùƒ</th>
                                <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                                <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            uniqueItems.slice(0, 100).forEach(item => {
                const gradeClass = item.grade?.toLowerCase().includes('platinum') ? 'platinum' :
                    item.grade?.toLowerCase().includes('gold') ? 'gold' :
                        item.grade?.toLowerCase().includes('signature') ? 'signature' : 'classic';

                tableHtml += `
                    <tr>
                        <td style="font-weight: bold; color: #FFD700;">${item.bin}</td>
                        <td><span class="country-tag">${item.country || '-'}</span></td>
                        <td>${item.cardType || '-'}</td>
                        <td>${item.brand || '-'}</td>
                        <td><span class="grade-tag ${gradeClass}">${item.grade || '-'}</span></td>
                        <td>${item.bank || '-'}</td>
                        <td>${item.count || 0}</td>
                        <td><span class="file-badge ${item.source === 'luozi' ? 'luozi' : 'quanzi'}">${item.source === 'luozi' ? 'è£¸èµ„' : 'å…¨èµ„'}</span></td>
                    </tr>
                `;
            });

            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;

            if (uniqueItems.length > 100) {
                tableHtml += `<p style="color: #888; text-align: center; margin-top: 15px;">...Ùˆ ${uniqueItems.length - 100} Ø§Ù„Ù…Ø²ÙŠØ¯</p>`;
            }

            container.innerHTML = tableHtml;
        }

        // Update database status
        function updateDbStatus(connected, message) {
            const statusEl = document.getElementById('db-status');
            const textEl = document.getElementById('db-status-text');

            if (connected) {
                statusEl.classList.remove('error');
                statusEl.classList.add('connected');
            } else {
                statusEl.classList.remove('connected');
                statusEl.classList.add('error');
            }

            textEl.textContent = message;
        }

        // Check database connection
        async function checkDbConnection() {
            try {
                const url = `${APPWRITE_CONFIG.endpoint}/databases/${APPWRITE_CONFIG.databaseId}/collections/${APPWRITE_CONFIG.collectionId}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: getHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    updateDbStatus(true, `Ù…ØªØµÙ„ - ${data.name || 'BIN Database'}`);
                } else {
                    updateDbStatus(false, 'ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                }
            } catch (error) {
                updateDbStatus(false, 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        // Current search type
        let currentSearchType = 'bin';

        // Set search type
        function setSearchType(type) {
            currentSearchType = type;

            // Update button styles
            document.querySelectorAll('.search-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');

            // Show/hide search boxes
            const simpleSearch = document.getElementById('simple-search');
            const advancedSearch = document.getElementById('advanced-search');
            const searchInput = document.getElementById('search-input');

            if (type === 'advanced') {
                simpleSearch.style.display = 'none';
                advancedSearch.style.display = 'block';
            } else {
                simpleSearch.style.display = 'flex';
                advancedSearch.style.display = 'none';

                // Update placeholder based on type
                const placeholders = {
                    'bin': 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… BIN (Ù…Ø«Ø§Ù„: 450979)',
                    'bank': 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ (Ù…Ø«Ø§Ù„: BANK OF AMERICA)',
                    'country': 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆÙ„Ø© (Ù…Ø«Ø§Ù„: UNITED STATES)',
                    'brand': 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© (Ù…Ø«Ø§Ù„: VISA)',
                    'grade': 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø© (Ù…Ø«Ø§Ù„: GOLD, PLATINUM, CLASSIC)',
                    'combo': 'Ø£Ø¯Ø®Ù„: BRAND - CARDTYPE - GRADE (Ù…Ø«Ø§Ù„: MASTERCARD - DEBIT - STANDARD)'
                };
                searchInput.placeholder = placeholders[type] || placeholders['bin'];
                searchInput.maxLength = type === 'combo' ? 100 : 50;
            }
        }

        // Perform simple search based on type
        async function performSearch() {
            const searchValue = document.getElementById('search-input').value.trim().toUpperCase();

            if (!searchValue) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ù„Ù„Ø¨Ø­Ø«');
                return;
            }

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results-container').style.display = 'none';
            document.getElementById('no-results').style.display = 'none';

            try {
                let queries = [];

                switch (currentSearchType) {
                    case 'bin':
                        queries = [{ "method": "equal", "attribute": "bin", "values": [searchValue] }];
                        break;
                    case 'bank':
                        queries = [
                            { "method": "search", "attribute": "bank", "values": [searchValue] },
                            { "method": "limit", "values": [500] }
                        ];
                        break;
                    case 'country':
                        queries = [
                            { "method": "equal", "attribute": "country", "values": [searchValue] },
                            { "method": "limit", "values": [500] }
                        ];
                        break;
                    case 'brand':
                        queries = [
                            { "method": "equal", "attribute": "brand", "values": [searchValue] },
                            { "method": "limit", "values": [500] }
                        ];
                        break;
                    case 'grade':
                        queries = [
                            { "method": "equal", "attribute": "grade", "values": [searchValue] },
                            { "method": "limit", "values": [500] }
                        ];
                        break;
                    case 'combo':
                        // Parse BRAND - CARDTYPE - GRADE format
                        const parts = searchValue.split('-').map(p => p.trim()).filter(p => p);
                        if (parts.length >= 1) {
                            queries.push({ "method": "equal", "attribute": "brand", "values": [parts[0]] });
                        }
                        if (parts.length >= 2) {
                            queries.push({ "method": "equal", "attribute": "cardType", "values": [parts[1]] });
                        }
                        if (parts.length >= 3) {
                            queries.push({ "method": "equal", "attribute": "grade", "values": [parts[2]] });
                        }
                        queries.push({ "method": "limit", "values": [500] });
                        break;
                }

                const result = await searchInAppwrite(queries);
                const results = result.documents || [];

                document.getElementById('loading').style.display = 'none';

                if (results.length === 0) {
                    document.getElementById('no-results').style.display = 'block';
                    return;
                }

                // For non-BIN searches, display as a list
                if (currentSearchType !== 'bin') {
                    displaySearchResults(searchValue, results, currentSearchType);
                } else {
                    await displayResults(searchValue, results);
                }

            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('no-results').style.display = 'block';
            }
        }

        // Perform advanced search
        async function performAdvancedSearch() {
            const bin = document.getElementById('adv-bin').value.trim();
            const bank = document.getElementById('adv-bank').value.trim().toUpperCase();
            const country = document.getElementById('adv-country').value.trim().toUpperCase();
            const brand = document.getElementById('adv-brand').value;
            const cardType = document.getElementById('adv-cardType').value;
            const grade = document.getElementById('adv-grade').value;

            // Build queries
            let queries = [];

            if (bin) queries.push({ "method": "equal", "attribute": "bin", "values": [bin] });
            if (bank) queries.push({ "method": "search", "attribute": "bank", "values": [bank] });
            if (country) queries.push({ "method": "equal", "attribute": "country", "values": [country] });
            if (brand) queries.push({ "method": "equal", "attribute": "brand", "values": [brand] });
            if (cardType) queries.push({ "method": "equal", "attribute": "cardType", "values": [cardType] });
            if (grade) queries.push({ "method": "equal", "attribute": "grade", "values": [grade] });

            if (queries.length === 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹ÙŠØ§Ø± Ø¨Ø­Ø« ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }

            // Add limit
            queries.push({ "method": "limit", "values": [500] });

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results-container').style.display = 'none';
            document.getElementById('no-results').style.display = 'none';

            try {
                const result = await searchInAppwrite(queries);
                const results = result.documents || [];

                document.getElementById('loading').style.display = 'none';

                if (results.length === 0) {
                    document.getElementById('no-results').style.display = 'block';
                    return;
                }

                displaySearchResults('Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…', results, 'advanced');

            } catch (error) {
                console.error('Advanced search error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('no-results').style.display = 'block';
            }
        }

        // Store current search results for re-sorting
        let currentSearchResults = [];

        // Display search results for non-BIN searches
        function displaySearchResults(searchTerm, results, searchType) {
            document.getElementById('results-container').style.display = 'block';

            // Store results for re-sorting
            currentSearchResults = [...results];

            // Sort results by count (highest to lowest) by default
            results.sort((a, b) => (b.count || 0) - (a.count || 0));

            // Update header
            document.getElementById('bin-number').textContent = `${results.length} Ù†ØªÙŠØ¬Ø©`;
            document.getElementById('found-files').textContent = searchType === 'bank' ? 'ğŸ¦ Ø¨Ù†Ùƒ' :
                searchType === 'country' ? 'ğŸŒ Ø¯ÙˆÙ„Ø©' :
                    searchType === 'brand' ? 'ğŸ’³ Ø¹Ù„Ø§Ù…Ø©' :
                        searchType === 'combo' ? 'ğŸ”— Ù…Ø±ÙƒØ¨' :
                            searchType === 'grade' ? 'â­ Ø¯Ø±Ø¬Ø©' : 'âš™ï¸ Ù…ØªÙ‚Ø¯Ù…';

            // Show sort controls
            document.getElementById('sort-controls').style.display = 'block';
            document.getElementById('sort-select').value = 'count-desc';

            // Hide similar sections for non-BIN searches
            document.getElementById('same-country-section').style.display = 'none';
            document.getElementById('other-countries-section').style.display = 'none';

            // Display results
            renderSortedResults(results);
        }

        // Apply sorting based on dropdown selection
        function applySorting() {
            const sortValue = document.getElementById('sort-select').value;
            let sortedResults = [...currentSearchResults];

            switch (sortValue) {
                case 'count-desc':
                    sortedResults.sort((a, b) => (b.count || 0) - (a.count || 0));
                    break;
                case 'count-asc':
                    sortedResults.sort((a, b) => (a.count || 0) - (b.count || 0));
                    break;
                case 'bin-asc':
                    sortedResults.sort((a, b) => (a.bin || '').localeCompare(b.bin || ''));
                    break;
                case 'bin-desc':
                    sortedResults.sort((a, b) => (b.bin || '').localeCompare(a.bin || ''));
                    break;
                case 'country-asc':
                    sortedResults.sort((a, b) => (a.country || '').localeCompare(b.country || ''));
                    break;
                case 'bank-asc':
                    sortedResults.sort((a, b) => (a.bank || '').localeCompare(b.bank || ''));
                    break;
            }

            renderSortedResults(sortedResults);
        }

        // Render sorted results
        function renderSortedResults(results) {
            document.getElementById('bin-info-grids').innerHTML = '';
            displaySimilarBins('bin-info-grids', results, '', true, true);
        }

        // Enter key support
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }

            // Check database connection
            checkDbConnection();
        });
    </script>
</body>

</html>